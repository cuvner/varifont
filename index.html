<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Combinatory p5 Poetry</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --scale: .5; } /* 1 = 800x400, .5 = 400x200 */
    body { margin:0; padding:24px; background:#f3f4f6; color:#0f172a; font: 400 20px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    h1 { margin:0 0 16px; font-weight:800; }
    .toolbar { display:flex; gap:10px; margin:8px 0 24px; }
    button { padding:8px 12px; border:1px solid #cbd5e1; border-radius:10px; background:#fff; cursor:pointer; }
    .muted { opacity:.6; }

    /* sentence layout */
    .line { display:flex; flex-wrap:wrap; gap:12px; align-items:center; font-size:28px; line-height:1.25; margin:18px 0; }
    .txt { display:inline-block; }

    /* iframe like the original preview app card – but without p5 header */
    .EmbedFrame__Frame {
      display:inline-block;
      width:calc(800px * var(--scale));
      height:calc(400px * var(--scale));
      border:0;
      border-radius:12px;
      background:#000;
      overflow:hidden;
    }

    .poems { max-width:1400px; }
  </style>
</head>
<body>
  <h1>Combinatory p5 Poetry</h1>
  <div class="toolbar">
    <button id="shuffleBtn">Shuffle</button>
    <span class="muted">Sheet → CSV → inline p5 embeds</span>
  </div>

  <div id="poems" class="poems"></div>

<script type="module">
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4yFkVdYOqwXrJhWwltBncbSr1TkfpRdlNALtb2v-IKXUaPzFOccj9-Ik0tfXHy9op_oVroaythjcL/pub?output=csv";

/** Convert p5 share links to the real embed endpoint. */
function toP5Embed(raw){
  try{
    const u = new URL(raw);
    if(u.hostname !== "editor.p5js.org") return raw;

    // /user/full/id  or  /user/present/id
    let m = u.pathname.match(/^\/([^/]+)\/(full|present)\/([^/]+)/);
    if(m) return `https://editor.p5js.org/${m[1]}/sketches/${m[3]}/embed`;

    // /user/sketches/id/full  or  /present
    m = u.pathname.match(/^\/([^/]+)\/sketches\/([^/]+)\/(full|present)/);
    if(m) return `https://editor.p5js.org/${m[1]}/sketches/${m[2]}/embed`;

    // /user/sketches/id  or already /embed
    m = u.pathname.match(/^\/([^/]+)\/sketches\/([^/]+)(?:\/embed)?$/);
    if(m) return `https://editor.p5js.org/${m[1]}/sketches/${m[2]}/embed`;

    return raw;
  }catch{ return raw; }
}

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

const state = { noun:[], verb:[], adjective:[] };

function sketchIframe(src, title=""){
  const embed = toP5Embed(src);
  // Attributes similar to original preview; sandbox omitted to allow p5 to run
  return `<iframe class="EmbedFrame__Frame"
                  src="${embed}"
                  title="${title}"
                  loading="lazy"
                  allow="fullscreen; autoplay; xr-spatial-tracking; clipboard-read; clipboard-write"
                  referrerpolicy="no-referrer"></iframe>`;
}

function render(n=8){
  const TEMPLATES = [
    "I {verb} that one day I {verb} a {adjective} {noun}.",
    "The {noun}. The {adjective} {noun}.",
    "After {verb} up the {adjective} {noun}. The {noun}.",
    "The {noun} is {verb} if I am {adjective}.",
    "...the act of {verb}."
  ];
  const mount = document.getElementById("poems");
  mount.innerHTML = "";

  for(let i=0;i<n;i++){
    const t = TEMPLATES[i % TEMPLATES.length];
    const line = document.createElement("div");
    line.className = "line";

    t.split(/(\{noun\}|\{verb\}|\{adjective\})/g).forEach(tok=>{
      const m = tok.match(/^\{(noun|verb|adjective)\}$/);
      if(m){
        const pos = m[1];
        const row = rand(state[pos]);
        if(row){
          line.insertAdjacentHTML("beforeend", sketchIframe(row.embed_url, row.word || row.title || ""));
        }else{
          const span = document.createElement("span");
          span.className = "txt muted";
          span.textContent = `(${pos})`;
          line.appendChild(span);
        }
      }else{
        const span = document.createElement("span");
        span.className = "txt";
        span.textContent = tok;
        line.appendChild(span);
      }
    });

    mount.appendChild(line);
  }
}

Papa.parse(CSV_URL + "&cb=" + Date.now(), {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: ({data})=>{
    state.noun = []; state.verb = []; state.adjective = [];
    data.forEach(r=>{
      const pos = (r.part_of_speech || r.pos || "").toLowerCase();
      const url = (r.embed_url || r.url || "").trim();
      if(["noun","verb","adjective"].includes(pos) && /^https?:\/\//.test(url)){
        state[pos].push({ ...r, embed_url: url });
      }
    });
    render(10);
  },
  error: err => {
    console.error(err);
    alert("Could not load the sheet CSV; open it directly to confirm it’s public.");
  }
});

document.getElementById("shuffleBtn").addEventListener("click", ()=>render(10));
</script>
</body>
</html>
