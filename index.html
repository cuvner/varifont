<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Combinatory p5 Poetry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      margin:0; padding:24px;
      background:#eee; color:#111;
      font: 400 20px/1.6 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    h1 { margin:0 0 16px; font-weight:700; }
    .toolbar { display:flex; gap:8px; margin-bottom:16px; }
    button {
      border:1px solid #bbb;
      padding:8px 12px;
      border-radius:10px;
      background:#fff;
      cursor:pointer;
    }
    .poems { display:grid; gap:22px; }
    .line { font-size:28px; line-height:1.3; display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    iframe.p5frame {
      width:800px; height:400px;
      border:0; border-radius:10px;
    }
    /* Example: shrink proportionally (half size) */
    .scaled iframe.p5frame { width:400px; height:200px; }
    .muted { opacity:.4 }
  </style>
</head>
<body>
  <h1>Combinatory p5 Poetry</h1>
  <div class="toolbar">
    <button id="shuffle">Shuffle all</button>
    <span class="muted">Powered by Google Sheet â†’ CSV</span>
  </div>
  <div id="poems" class="poems"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4yFkVdYOqwXrJhWwltBncbSr1TkfpRdlNALtb2v-IKXUaPzFOccj9-Ik0tfXHy9op_oVroaythjcL/pub?output=csv";

// ---- Helpers ----
function random(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function toP5Embed(raw) {
  try {
    const u = new URL(raw);
    if (u.hostname !== 'editor.p5js.org') return raw;

    // case: /user/full/id OR /user/present/id
    const m1 = u.pathname.match(/^\/([^/]+)\/(full|present)\/([^/]+)/);
    if (m1) return `https://editor.p5js.org/${m1[1]}/sketches/${m1[3]}/embed`;

    // case: /user/sketches/id/full OR .../present
    const m2 = u.pathname.match(/^\/([^/]+)\/sketches\/([^/]+)\/(full|present)/);
    if (m2) return `https://editor.p5js.org/${m2[1]}/sketches/${m2[2]}/embed`;

    // already a sketch path, normalize to /embed
    const m3 = u.pathname.match(/^\/([^/]+)\/sketches\/([^/]+)(?:\/embed)?$/);
    if (m3) return `https://editor.p5js.org/${m3[1]}/sketches/${m3[2]}/embed`;

    return raw;
  } catch {
    return raw;
  }
}

// ---- Templates ----
const TEMPLATES = [
  "I {verb} that one day I {verb} a {adjective} {noun}.",
  "The {noun}. The {adjective} {noun}.",
  "After {verb} up the {adjective} {noun}. The {noun}.",
  "The {noun} is {verb} if I am {adjective}.",
  "...the act of {verb}."
];

const state = { noun:[], verb:[], adjective:[] };

// ---- Render ----
function makeIframe(row, scale=1) {
  const src = toP5Embed(row.embed_url);
  const title = row.word || row.title || "";
  const w = 800 * scale, h = 400 * scale;
  return `<iframe class="p5frame" src="${src}" title="${title}" width="${w}" height="${h}"></iframe>`;
}

function renderPoems(n=10) {
  const mount = document.getElementById("poems");
  mount.innerHTML = "";
  for (let i=0; i<n; i++) {
    const t = TEMPLATES[i % TEMPLATES.length];
    const html = t.replace(/\{(noun|verb|adjective)\}/g, (_, pos) => {
      const row = random(state[pos]);
      return row ? makeIframe(row, 0.5) : `<span class="muted">(${pos})</span>`;
    });
    const line = document.createElement("div");
    line.className = "line";
    line.innerHTML = html;
    mount.appendChild(line);
  }
}

// ---- Load CSV ----
Papa.parse(CSV_URL + "&cb=" + Date.now(), {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: ({ data }) => {
    data.forEach(r => {
      const pos = (r.part_of_speech || "").toLowerCase();
      if (["noun","verb","adjective"].includes(pos)) {
        state[pos].push(r);
      }
    });
    renderPoems(8);
  },
  error: (err) => console.error("CSV load failed:", err)
});

document.getElementById("shuffle").addEventListener("click", () => renderPoems(8));
</script>
</body>
</html>
